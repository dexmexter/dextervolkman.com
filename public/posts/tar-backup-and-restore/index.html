<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Preamble In my quest to learn and become more proficient with computers, I will often have some kind of ongoing personal project that I will work on in my spare time. Over the past few weeks the project that has taken up my evenings has been building a Linux From Scratch system. The goal is to build a working linux system by downloading and compiling everything manually from the source code." />
<meta name="keywords" content=", linux, tar, howto, backup" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://dextervolkman.com/posts/tar-backup-and-restore/" />


    <title>
        
            Tar Backup and Restore :: Dexter&#39;s Personal Site  — An IT support technician and Linux enthusiast
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.753fac8f03736f0edc9be411eb20cee875dd7bb8e73c8155fbf6a629c863f4ca.css">






<meta itemprop="name" content="Tar Backup and Restore">
<meta itemprop="description" content="Preamble In my quest to learn and become more proficient with computers, I will often have some kind of ongoing personal project that I will work on in my spare time. Over the past few weeks the project that has taken up my evenings has been building a Linux From Scratch system. The goal is to build a working linux system by downloading and compiling everything manually from the source code.">
<meta itemprop="datePublished" content="2020-05-16T15:06:00-07:00" />
<meta itemprop="dateModified" content="2020-05-16T20:58:09-07:00" />
<meta itemprop="wordCount" content="1115">
<meta itemprop="image" content="https://dextervolkman.com"/>



<meta itemprop="keywords" content="linux,tar,howto,backup," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dextervolkman.com"/>

<meta name="twitter:title" content="Tar Backup and Restore"/>
<meta name="twitter:description" content="Preamble In my quest to learn and become more proficient with computers, I will often have some kind of ongoing personal project that I will work on in my spare time. Over the past few weeks the project that has taken up my evenings has been building a Linux From Scratch system. The goal is to build a working linux system by downloading and compiling everything manually from the source code."/>



    <meta property="og:title" content="Tar Backup and Restore" />
<meta property="og:description" content="Preamble In my quest to learn and become more proficient with computers, I will often have some kind of ongoing personal project that I will work on in my spare time. Over the past few weeks the project that has taken up my evenings has been building a Linux From Scratch system. The goal is to build a working linux system by downloading and compiling everything manually from the source code." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dextervolkman.com/posts/tar-backup-and-restore/" />
<meta property="og:image" content="https://dextervolkman.com"/>
<meta property="article:published_time" content="2020-05-16T15:06:00-07:00" />
<meta property="article:modified_time" content="2020-05-16T20:58:09-07:00" /><meta property="og:site_name" content="Dexter&#39;s Personal Site" />






    <meta property="article:published_time" content="2020-05-16 15:06:00 -0700 PDT" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">[dexmexter]$ cd ~ </span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://dextervolkman.com/about">About</a></li><li><a href="https://dextervolkman.com/interests">Interests</a></li><li><a href="https://dextervolkman.com/posts">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>6 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://dextervolkman.com/posts/tar-backup-and-restore/">Tar Backup and Restore</a>
            </h1>
                <hr />
                <aside id="toc">
                <div class="toc-title">Table of Contents</div>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#preamble">Preamble</a></li>
    <li><a href="#backup-system">Backup system</a></li>
    <li><a href="#prepare-new-drive">Prepare new drive</a></li>
    <li><a href="#transfer-backup-to-the-new-drive">Transfer backup to the new drive</a></li>
    <li><a href="#restore-grub">Restore grub</a></li>
  </ul>
</nav>
                </aside>
                <hr />

            

            <div class="post-content">
                <h2 id="preamble">Preamble</h2>
<p>In my quest to learn and become more proficient with computers, I will often
have some kind of ongoing personal project that I will work on in my spare
time. Over the past few weeks the project that has taken up my evenings has
been building a <a href="http://www.linuxfromscratch.org/index.html">Linux From
Scratch</a> system. The goal is to
build a working linux system by downloading and compiling everything manually
from the source code.</p>
<p>I chose the systemd version of <a href="http://www.linuxfromscratch.org/lfs/view/stable-systemd/">the
book</a> to walk
through.  I learned a ton about how programs are built and what pieces are
needed for a working system. I ended up with an extremely basic but functioning
linux system. It was a fun and rewarding project but was also a fairly tedious
process to compile every package manually. If I were to ever do it again I will
likely go for the <a href="http://www.linuxfromscratch.org/alfs/">Automated Linux From
Scratch</a> version.</p>
<p>If you are wanting to look at the system you can download the backup right
<a href="https://drive.google.com/file/d/1JXqcG9EnXOpNSHf7I5TTrtikatTHqPnF/view?usp=sharing">here</a>.</p>
<p>I have no intentions of using this system on a regular basis but I did want to
find a way to back it up and make it available somewhere that I can look back
at later. Figuring out how to actually backup and restore the system was not
nearly as straight forward as I initially expected, mostly because I did not
have much prior experience with backing up and restoring a linux system. This
was a big part of the learning process and I wanted to document that portion
because I am sure it will be useful to reference later.</p>
<p>This is one way to create a full system backup and restore that backup to a new
disk. These instructions are based on <a href="https://help.ubuntu.com/community/BackupYourSystem/TAR">this
page</a> from the Ubuntu
Community Wiki. I also needed some help getting the system to boot which I
eventually found
<a href="https://howtoubuntu.org/how-to-repair-restore-reinstall-grub-2-with-a-ubuntu-live-cd">here</a>.</p>
<h2 id="backup-system">Backup system</h2>
<p>The backup process can be done from the system that is being backed up. This
process uses the <code>tar</code> program to create on archive of all the system files,
this archive is then compressed so it takes up less space. The following
commands should either be prefaced with <code>sudo</code>. If you do not want to type
<code>sudo</code> before every command, you can switch to the root user with <code>sudo su</code>.</p>
<p>Switch to root directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /
</code></pre></div><p>Run tar to backup the entire system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -cvpzf backup.tar.gz --exclude<span style="color:#f92672">=</span>/backup.tar.gz --one-file-system /
</code></pre></div><p>Let&rsquo;s break that down.</p>
<ul>
<li><code>tar</code> A program used for working with archives.
<ul>
<li><code>c</code> - create a new archive</li>
<li><code>v</code> - verbose mode</li>
<li><code>p</code> - preserve file permissions</li>
<li><code>z</code> - compress the archive</li>
<li><code>f</code> <!-- raw HTML omitted --> - the name of the archive file to being created. It will be
made in the working directory.</li>
</ul>
</li>
<li><code>--exclude=/example/path</code> - This is a list of directories that the program
should not backup. It is important that tar doesn&rsquo;t try to backup the archive
it is using creating, this would create a recursive mess and is sure to break
things.</li>
<li><code>--one-file-system</code> - This is used to prevent tar from trying to backup any
other filesystems, including virtual filesystems like <code>/proc</code>, <code>/sys</code>,
<code>/mnt</code>, <code>/media</code>, <code>/run</code>, and <code>/dev</code>. These are temporary filesystems
specific to a running  system and will be recreated when the system is
booted. Backing them up would cause issues.</li>
<li><code>/</code> - Last comes the directory being backed up, in this case we are backing
up the root directory which will recursively include the entire system.</li>
</ul>
<p>Once this process has completed, the archive can be copyied or moved to a USB.
Plug in the USB and locate it with <code>lsblk</code> or <code>fdisk -l</code>. Next mount the drive.
Replace <code>XY</code> with the letter and partition number for the USB drive.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mount /dev/sdXY /mnt
</code></pre></div><p>Move the archive file to the USB drive.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv /backup.tar.gz /mnt/
</code></pre></div><p>Unmount the USB.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">umount /mnt
</code></pre></div><p>The USB can now be removed. The system has now been succesfully backed up. Next
we will move onto how to restore the archive to a different hard drive.</p>
<h2 id="prepare-new-drive">Prepare new drive</h2>
<p>This next section should be done from a Live installation environment. For
instructions on how to create a bootable USB, download an ISO and go
through my <a href="/posts/bootable-usb">previous post</a> (Ubuntu is a good
place to start but any distribution with a Live installer will work).</p>
<p>Once you are have the hard drive you wish to restore to hooked up and are
booted into the recovery environment, the next step is to format and prepare
the new drive. These instructions have only been tested with Legacy Boot and
will not work with a UEFI system. Booting with UEFI is beyond the scope of this
post.</p>
<p>The easiest way to prepare the new drive is using <code>gparted</code> or a similar
program. You&rsquo;ll need to format the drive with a new partition table as well as
a new partition that is formated with a filesystem, typically <code>Ext4</code> is used.</p>
<h2 id="transfer-backup-to-the-new-drive">Transfer backup to the new drive</h2>
<p>Make sure that the new drive is mounted. Then copy all the contents of the
archive to the new drive.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -xcpzf /path/to/backup.tar.gz -C /path/to/mounted/drive --numeric-owner
</code></pre></div><p>Options explained:</p>
<ul>
<li><code>x</code> - Tells tar to extract the archive file.</li>
<li><code>-C &lt;directory&gt;</code> - Change to a specific directory before extracting. In this
case it would be the path where the filesystem for the new drive is mounted.</li>
<li><code>--numeric-owner</code> - Tells tar to restore the numeric owners of the files in
the archive, rather than any user names from the restoration environment that
might match accidentally making some files inaccessible because of
missmatched user id&rsquo;s.</li>
</ul>
<h2 id="restore-grub">Restore grub</h2>
<p>Lastly we need to restore the bootloader in order to make the system bootable
again. These commands assume that the partiton with the filesystem is
mounted to <code>/mnt</code>.</p>
<p>Bind the directories that <code>grub</code> will need.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo mount --bind /dev /mnt/dev <span style="color:#f92672">&amp;&amp;</span>
sudo mount --bind /dev/pts /mnt/dev/pts <span style="color:#f92672">&amp;&amp;</span>
sudo mount --bind /proc /mnt/proc <span style="color:#f92672">&amp;&amp;</span>
sudo mount --bind /sys /mnt/sys
</code></pre></div><p>Jump into the restored system with <code>chroot</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo chroot /mnt
</code></pre></div><p>Install <code>grub</code> to the device holding the restored system. Then check that it
installed correctly and update.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">grub-install /dev/sdX
grub-install --recheck /dev/sdX
update-grub
</code></pre></div><p>It is a good idea to check that <code>/etc/fstab</code> and <code>boot/grub/grub.cfg</code> are
referencing the correct drives and partition numbers.</p>
<p>That&rsquo;s it! You can now <code>exit</code>, <code>unmount</code> everything and then <code>reboot</code> the system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">exit <span style="color:#f92672">&amp;&amp;</span>
sudo umount /mnt/sys <span style="color:#f92672">&amp;&amp;</span>
sudo umount /mnt/proc <span style="color:#f92672">&amp;&amp;</span>
sudo umount /mnt/dev/pts <span style="color:#f92672">&amp;&amp;</span>
sudo umount /mnt/dev <span style="color:#f92672">&amp;&amp;</span>
sudo umount /mnt

sudo reboot
</code></pre></div><p>Hopefully it boots. If you can get to the <code>grub</code> command line but cannot boot
into the file system, <code>grub.cfg</code> is probably misconfigured and looking for the
incorrect drive to boot from. You&rsquo;ll need to find other instructions for how to
find and boot with the correct settings from within <code>grub</code>.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://dextervolkman.com/tags/linux">linux</a></span><span class="tag"><a href="https://dextervolkman.com/tags/tar">tar</a></span><span class="tag"><a href="https://dextervolkman.com/tags/howto">howto</a></span><span class="tag"><a href="https://dextervolkman.com/tags/backup">backup</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1115 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-05-16 15:06 -0700</p>
                <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="6211f534e90fcf4520d47e4a35b335ae27fa84fb" target="_blank" rel="noopener">6211f53</a> @ 2020-05-16</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://dextervolkman.com/posts/mpd_not_working/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Mpd not working? Try starting with --user</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://dextervolkman.com/posts/bootable-usb/">
                                <span class="button__text">Create a Bootable USB with dd</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://dextervolkman.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4a69500057d68129e88f497d354afe68422eb56de6d15e45dbe2190858ea5a76bfcb096406f992984b241db45f47388ac57ab0376e3b32125bef7a8a6d0f06c4.js" integrity="sha512-SmlQAFfWgSnoj0l9NUr&#43;aEIutW3m0V5F2&#43;IZCFjqWna/ywlkBvmSmEskHbRfRziKxXqwN247MhJb73qKbQ8GxA=="></script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166761220-1', 'auto');
	
	ga('send', 'pageview');
}
</script>




    </body>
</html>
